## Return value optimization

```cpp
mytype f() {
    return mytype(1, 2, 3);    
}

// компилится во что-то, похожее на:
void f(void* result) {
    mytype_ctor(result, 1, 2, 3);
}
```

Если из функции возвращается `rvalue`, то копия не создаётся и объект конструируется уже на месте, куда возвращается значение. Начиная с C++17 эта оптимизация обязательна для компилятора и вошла в стандарт под названием `Copy elision`.

Поэтому нельзя опираться на то, что у такого объекта конструкторы копирования, перемещения и/или деструктор обязательно будет вызваны при выходе из функции.

## Named return value optimization

Позволяет избежать копирования при возврате объекта с автоматическим размещением. На данный момент эта оптимизация необязательная. Пример:

```cpp
std::string f() {
    std::string tmp;
    for (;;) {
        tmp += ...;
    }
    return tmp;
}

// можно разместить tmp уже на result-е, псевдокод:
void f(void* result) {
    string_ctor(result, "abc");
    for (;;) {
        *result += ...;
    }
}
```

Применить её можно не во всех случаях. Например:

```cpp
std::string g() {
    std::string a("abc");
    std::string b("def");
    if (flag) {
        return a;
    } else {
        return b;
    }
}
```

Ещё один пример, когда избегается копирование:

```cpp
void g() {
    mytype a = f(); // здесь не будет вызван конструктор копирования
}
```

### Link-time optimization

На стадии трансляции некоторые функции не переводятся в ассемблер для того, чтобы провести оптимизацию на этапе линковки, во время встраивания кода этих функций.

Проведение оптимизаций "на месте" может значительно лучше приспособить код, по сравнению с обычным встраиванием, однако LTO в деле требует мощного компьютера при сборке проектов (в основном требуется больше оперативной памяти). LTO также может снизить конечный размер бинарника по сравнению с обычным инлайнингом.

На текущий момент далеко не все разработчики рекомендуют включать этот параметр при сборке, так как он нестабилен и иногда приводит не к впечатляющим результатам.


---

Заимствования:

[«Скользкие» места C++17 / Хабр (habr.com)](https://habr.com/ru/company/playrix/blog/465181/)

[cpp-notes/14_move_rvalue.md at master · lejabque/cpp-notes (github.com)](https://github.com/lejabque/cpp-notes/blob/master/src/14_move_rvalue.md)