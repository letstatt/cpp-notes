## Спецификатор volatile

Спецификатор `volatile` говорит компилятору, что оптимизировать данную переменную запрещено, и что компилятор никогда не сможет предвидеть или вычислить ее значение заранее.

```cpp
volatile int flag = 42;
```

Когда это вообще нужно? Рассмотрим следующий пример:

```cpp
bool cancel = false;
/* ... */

while (!cancel) {
	/* ... */
}
```

Если в теле цикла переменная `cancel` не меняется, то компилятор может соптимизировать ее проверку, и в цикл мы не войдем никогда.

Таким и должно быть наблюдаемое поведение, если мы не пишем сложной логики, например, если переменная `cancel` не шарится с другими потоками или процессами, которые могут ее перезаписывать. Использование `volatile` нужно для предупреждения компилятора, что _магические силы_ могут изменить значение переменной в любой момент и нельзя опираться на то, что в нее было записано в compile-time.

Другой пример:

```cpp
unsigned char* pControl = 0xff24;

void f() {
	*pControl = 1;
	*pControl = 0;
	*pControl = 0;
}
```

Компилятор может опустить первые две операции присваивания, оставив только последнюю. Когда это может быть вредно? При разработке программ, работающих с `Memory mapped IO`, то есть взаимодействующих с какими-то железками через оперативную память, или при разработке драйверов, где важно каждое переданное значение.

Использование `volatile` запрещает перегруппировку инструкций доступа и их оптимизацию, но ни в коем случае не гарантирует атомарности. Чтение `volatile` переменной при одновременной записи в нее из другого потока или одновременная запись из разных потоков без синхронизации - это data race.

Также использование `volatile` запрещает использование переменной из регистра - каждое чтение будет связано с загрузкой из оперативной памяти.

Разумеется, нельзя использовать волатильную переменную со снятым позднее через `const_cast` спецификатором `volatile` - это undefined behavior.


---

Заимствования:

[volatile type qualifier - cppreference.com](https://en.cppreference.com/w/c/language/volatile)

[Алёна C++: Ключевое слово volatile (alenacpp.blogspot.com)](http://alenacpp.blogspot.com/2006/04/volatile.html)
